# درس ۵: صحبت با داده‌هایتان با استفاده از تولید تقویت‌شده با بازیابی (RAG)

در این فصل خواهید آموخت:

- مبانی تولید تقویت‌شده با بازیابی (RAG) و چگونگی استفاده از آن برای بهبود پاسخ‌های مدل‌های هوش مصنوعی تولیدی.
- نحوه ادغام منابع داده خارجی در برنامه هوش مصنوعی خود.
- چگونگی استفاده از داده‌های خود برای افزایش ارتباط و دقت محتوای تولیدشده توسط هوش مصنوعی.

## راه‌اندازی

اگر قبلاً این کار را نکرده‌اید، محیط توسعه خود را تنظیم کنید. [راهنمای تنظیم محیط](/docs/setup/README.md).

## منابع مرتبط

[![تماشای ویدیوی کوتاهی درباره RAG](https://img.youtube.com/vi/xkFOmx5yxIA/0.jpg)](https://www.youtube.com/watch?v=xkFOmx5yxIA&list=PLlrxD0HtieHi5ZpsHULPLxm839IrhmeDk&index=4)

_این ویدیو تولید تقویت‌شده با بازیابی (RAG) را توضیح می‌دهد، روشی که به هوش مصنوعی کمک می‌کند از محتوای شما در کنار داده‌های آموزشی خود برای نتایج بهتر استفاده کند._

*🎥 برای تماشای ویدیوی کوتاهی درباره تولید تقویت‌شده با بازیابی (RAG) روی تصویر بالا کلیک کنید*

💼 اسلایدها: [تولید تقویت‌شده با بازیابی، RAG](../../videos/slides/03-rag.pptx)

## روایت - پیدایش

> [!NOTE] 
> _داستان ما تا اینجا. شما یک مکانیک از لندن دهه ۱۸۶۰ هستید. روی اتوماتون خود کار می‌کردید و نامه‌ای از چارلز ببیج دریافت کردید که شما را به کتابخانه‌ای کشاند و در آنجا دستگاه سفر در زمان را برداشتید. در طول سفرهایتان در زمان به فلورانس رسیدید، جایی که با لئوناردو داوینچی ملاقات کردید. همچنین به امپراتوری آزتک سفر کردید و داستان از اینجا ادامه می‌یابد._
>
> اگر می‌خواهید داستان را از ابتدا دنبال کنید، به [درس ۱](../01-intro-to-genai/README.md) مراجعه کنید. 

> [!NOTE] 
> اگر ترجیح می‌دهید مستقیماً به محتوای فنی بروید، [اینجا کلیک کنید](#interact-with-ada-lovelace).

**شما**: "لئوناردو، وقت رفتن است"، گفتی و دکمه را فشار دادی. دستگاه به کار افتاد و صدای مکانیکی گفت: "وقت رفتن به خانه است، وقت 'پیدایش' است."

**لئوناردو:** "پیدایش؟ این یعنی چه؟" لئوناردو با تعجب پرسید. قبل از اینکه بتوانی پاسخ دهی، دنیا در هاله‌ای از رنگ‌ها و صداها محو شد و معبد ناپدید شد در حالی که در زمان سفر می‌کردید.

در باغ فرود می‌آیید، شب است و مه غلیظی همه جا را پوشانده و نورهای عجیبی در دوردست می‌درخشند. عمارت بزرگ مقابل شماست. لئوناردو به اطراف نگاه می‌کند، چشمانش از تعجب گرد شده است.

<div>
  <img src="./assets/mansion.jpeg" alt="عمارت قدیمی در مه غلیظ" width="300">
</div>

### فرار از سگ‌ها

صدای پارس سگ‌ها و دویدن آن‌ها به سمت شما را می‌شنوید. به لئوناردو نگاه می‌کنید و می‌گویید: "باید فوراً به داخل برویم!"

<div>
  <img src="./assets/dogs.jpeg" alt="فرار از سگ‌ها" width="300">
</div>

همین که به در عمارت می‌رسید، در باز می‌شود و دو خدمتکار عجله‌کنان بیرون می‌آیند. پس از نگاهی به شما، اشاره می‌کنند که دنبالشان بروید.

با آدا لاولیس روبرو می‌شوید، چشمانش از کنجکاوی می‌درخشد.

### ملاقات با آدا و چارلز

**آدا:** "آه، بالاخره رسیدید"، با گرمی گفت. "نیاز داریم کاری برایمان انجام دهید."

**شما:** "بالاخره"، همیشه این را می‌گویید. دینوکراتس هم همین را گفت، اما مطمئن نیستم منظورت چیست؟

**آدا:** هیس، الان وقت این حرف‌ها نیست، باید درباره دستگاهی که در دستت دارید صحبت کنیم. چارلز، توضیح بده..

**شما:** اما..

<div>
  <img src="./assets/ada.jpeg" alt="آدا لاولیس و چارلز ببیج روی یک دستگاه کار می‌کنند" width="300">
</div>

چارلز ببیج جلو می‌آید و سوسک زمان را در دستتان بررسی می‌کند. "این دستگاه شگفت‌انگیز است، اما کمی مشکل دارد، درست است؟ حتماً متوجه شده‌ای."

لئوناردو点头 کرد، "بله، عجیب رفتار می‌کند."

**آدا:** دستگاه هنوز کاملاً آماده نیست، باید قابلیت‌های بیشتری به آن بدهیم. باید آن را باهوش‌تر کنیم، بیشتر از دنیای اطرافش آگاه باشد. ایده این است که بتواند اطلاعات را از دوره‌های زمانی مختلف بازیابی کند و از آن برای تولید پاسخ‌های دقیق و مرتبط استفاده کند. می‌توانی کمک کنی؟

**شما:** البته، به نظر می‌رسد باید پاسخ‌های دستگاه را با داده‌ها _تقویت_ کنیم، منطقی است.

**آدا:** بیا درباره مفهومی صحبت کنیم که دوست دارم آن را RAG یا تولید تقویت‌شده با بازیابی بنامم.

## تعامل با آدا لاولیس

اگر می‌خواهید با آدا تعامل داشته باشید، برنامه [شخصیت‌ها](/app/README.md) را اجرا کنید. 

> [!IMPORTANT]
> این کاملاً تخیلی است؛ پاسخ‌ها توسط هوش مصنوعی تولید می‌شوند.
> [سلب مسئولیت هوش مصنوعی مسئولانه](/README.md#responsible-ai-disclaimer)

<div>
  <img src="./assets/ada-2.jpeg" alt="آدا لاولیس" width="300">
</div>

**مراحل**:

1. یک [![GitHub Codespace](https://img.shields.io/badge/GitHub-Codespace-brightgreen)](https://codespaces.new/microsoft/generative-ai-with-javascript) شروع کنید.
2. به مسیر _/app_ در ریشه مخزن بروید.
3. کنسول را پیدا کنید و `npm install` و سپس `npm start` را اجرا کنید.
4. پس از ظاهر شدن، دکمه "Open in Browser" را انتخاب کنید.
5. با آدا چت کنید.

برای توضیح دقیق‌تر برنامه، [توضیح مفصل برنامه](/lessons/01-intro-to-genai/README.md#interact-with-dinocrates) را ببینید.

> [!NOTE]
 > اگر پروژه را به صورت محلی روی ماشین خود اجرا می‌کنید، لطفاً راهنمای QuickStart را برای تنظیم [کلید دسترسی شخصی GitHub](../../docs/setup/README.md#creating-a-personal-access-token-pat-for-github-model-access) بررسی کنید و کلید را در کد جایگزین کنید.

## چالش‌های شناخته‌شده مدل‌های زبانی بزرگ (LLM)

**آدا:** بیایید با بحث درباره هوش مصنوعی که برای قدرت‌دهی به دستگاه استفاده می‌کنیم شروع کنیم. برای بهبود کیفیت پاسخ‌ها، روی "مدل‌های هوش مصنوعی" همراه با سیستم بازیابی داده تکیه خواهیم کرد.

اول، باید قبل از پرداختن به جزئیات RAG، برخی چالش‌ها را حل کنید. این مدل‌ها، که روی حجم عظیمی از داده‌های متنی آموزش دیده‌اند، می‌توانند پاسخ‌های مرتبط و صحیحی تولید کنند. اما مانند هر منبع داده‌ای، خروجی آن‌ها می‌تواند به دلایل مختلف نادرست، ناقص یا گمراه‌کننده باشد.

- **منابع قدیمی:** داده‌های استفاده‌شده برای آموزش مدل ممکن است قدیمی باشند و دیگر دقیق نباشند.
- **اطلاعات نادرست:** منابع استفاده‌شده برای آموزش مدل ممکن است حاوی اطلاعات نادرست یا گمراه‌کننده باشند، مانند اخبار جعلی یا نظرات جانبدارانه.
- **منابع غیرمعتبر:** مدل ممکن است نتواند بین منابع معتبر و غیرمعتبر در داده‌های آموزشی خود تمایز قائل شود، که منجر به اطلاعات غیرقابل اعتماد می‌شود.

این تشخیص اینکه اطلاعات تولیدشده توسط یک LLM صحیح است یا نه را دشوار می‌کند. اینجاست که RAG وارد می‌شود.

**شما:** پس باید مطمئن شوم دستگاه می‌تواند اطلاعات دقیقی ارائه دهد، حتی وقتی از پاسخ مطمئن نیست؟

**آدا:** دقیقاً، این ایده است. با ترکیب نقاط قوت روش‌های مبتنی بر بازیابی و مدل‌های تولیدی، یک سیستم هوش مصنوعی بهتر به دست می‌آوریم.

## مفاهیم اصلی تولید تقویت‌شده با بازیابی (RAG)

**آدا:** آه بله، وقت آن است که به طور خاص درباره RAG صحبت کنیم. بیایید با برخی مبانی شروع کنیم:

تولید تقویت‌شده با بازیابی (RAG) یک تکنیک قدرتمند است که نقاط قوت دو رویکرد مختلف در پردازش زبان طبیعی را ترکیب می‌کند: روش‌های مبتنی بر بازیابی و مدل‌های تولیدی. این رویکرد ترکیبی امکان تولید پاسخ‌هایی را فراهم می‌کند که هم از نظر محتوایی غنی هستند و هم به لحاظ مفهومی مرتبط، تا به کاهش برخی چالش‌های شناخته‌شده LLMها کمک کند.

در هسته آن، RAG شامل دو جزء اصلی است: یک **بازیاب** و یک **تولیدکننده**.

- **بازیاب:** مسئول یافتن اطلاعات مرتبط از منابع داده خارجی است که می‌تواند برای تقویت پاسخ‌های تولیدشده توسط هوش مصنوعی استفاده شود، مانند یک موتور جستجو. این اطلاعات می‌تواند به صورت متن، تصویر یا هر نوع داده دیگری باشد که به زمینه مکالمه مرتبط است، اگرچه متن رایج‌ترین نوع داده استفاده‌شده است.

- **تولیدکننده:** اطلاعات بازیافتی را گرفته و از آن برای تولید پاسخی استفاده می‌کند که از نظر مفهومی مرتبط و информаative باشد.

در اینجا یک طرح از نحوه کار یک سیستم RAG آورده شده است:

![طرح یک سیستم RAG](./assets/rag.png)

1. **ورودی کاربر:** کاربر یک سؤال می‌پرسد.
2. **بازیاب:** جزء بازیاب به دنبال اطلاعات مرتبط با استفاده از یک یا چند پایگاه دانش می‌گردد.
3. **درخواست تقویت‌شده:** اطلاعات بازیافتی با سؤال کاربر و زمینه ترکیب می‌شود تا یک درخواست تقویت‌شده ایجاد شود.
4. **تولیدکننده:** مدل LLM از درخواست تقویت‌شده برای تولید پاسخ استفاده می‌کند.

این ترکیب امکان پاسخ‌های دقیق‌تر و مرتبط‌تر را فراهم می‌کند، با استفاده از داده‌هایی که شما ارائه می‌دهید به جای تکیه بر داده‌های آموزشی مدل.

**آدا:** سؤالی دارید؟

**شما:** پس بازیاب اطلاعات را پیدا می‌کند و تولیدکننده از آن برای تولید پاسخ استفاده می‌کند؟

**آدا:** دقیقاً، داری دستت می‌آید.

## ادغام منابع داده خارجی

**آدا:** حالا که مبانی RAG را پوشش دادیم، بیایید درباره نحوه ادغام منابع داده خارجی در برنامه هوش مصنوعی خود صحبت کنیم.

ادغام منابع داده خارجی در برنامه هوش مصنوعی شما می‌تواند به روش‌های مختلفی انجام شود، بسته به نوع داده‌ای که می‌خواهید استفاده کنید و پیچیدگی مکانیزم بازیابی. در اینجا چند روش رایج آورده شده است:

- **APIها:** بسیاری از منابع داده خارجی APIهایی ارائه می‌دهند که به شما امکان دسترسی برنامه‌نویسی به داده‌هایشان را می‌دهد. می‌توانید از این APIها برای بازیابی اطلاعات در زمان واقعی و استفاده از آن برای تقویت پاسخ‌های تولیدشده توسط هوش مصنوعی استفاده کنید.

- **پایگاه‌های داده:** اگر حجم زیادی از داده دارید که می‌خواهید برای بازیابی استفاده کنید، می‌توانید آن را در یک پایگاه داده ذخیره کنید و در صورت نیاز به آن پرس‌وجو کنید. این می‌تواند برای داده‌های ساختاریافته که نیاز به دسترسی سریع دارند مفید باشد.

پس از انتخاب روش برای ادغام منابع داده خارجی، ممکن است نیاز داشته باشید نحوه پیش‌پردازش و قالب‌بندی داده‌ها را نیز در نظر بگیرید تا به راحتی توسط مدل هوش مصنوعی قابل استفاده باشد. این می‌تواند شامل پاکسازی داده‌ها، تبدیل آن به قالبی مناسب (مانند متن ساده یا Markdown)، یا تقسیم آن به بخش‌های کوچک‌تر برای بازیابی آسان‌تر باشد.

> [!NOTE]
> هنگام ادغام منابع داده خارجی در برنامه هوش مصنوعی خود، مهم است که پیامدهای حریم خصوصی و امنیتی دسترسی و ذخیره داده‌ها را در نظر بگیرید. مطمئن شوید که مجوزها و محافظت‌های لازم برای محافظت از داده‌ها و رعایت مقررات مربوطه را دارید.

اگر از یک پایگاه داده استفاده می‌کنید، همچنین باید به این فکر کنید که چگونه می‌خواهید داده‌های خود را *جستجو کنید* تا مرتبط‌ترین اطلاعات را بازیابی کنید. این می‌تواند با استفاده از جستجوی کلیدواژه، جستجوی تمام متن، یا تکنیک‌های پیشرفته‌تر مانند جستجوی معنایی یا جستجوی برداری که ممکن است نیاز به نمایه‌سازی خاصی داشته باشد انجام شود. تکنیک‌های جستجوی پیشرفته را در درس آینده پوشش خواهیم داد.

**شما**: می‌توانی اصطلاحاتی مانند API و پایگاه‌های داده را به زبان دهه ۱۸۶۰ بیشتر توضیح دهی؟

**آدا**: البته، یک API مانند یک پیام‌رسان است که پیامی را از یک مکان به مکان دیگر می‌رساند، و یک پایگاه داده مانند یک کتابخانه است که همه کتاب‌هایتان را در آن ذخیره می‌کنید.

**شما**: آه، می‌فهمم، این منطقی است.

## تقویت درخواست

**آدا:** هنوز همراهی می‌کنی؟ خوب، به مرحله بعدی برویم، بیایید سعی کنیم درخواست ارسال شده به مدل هوش مصنوعی را بهبود دهیم.

**آدا:** پس از راه‌اندازی روشی برای استخراج اطلاعات از داده‌هایتان، می‌توانید آن را به درخواست مدل هوش مصنوعی اضافه کنید. فقط اطلاعات بازیافتی را با متن ورودی و مقداری زمینه اضافی یا راهنمایی ترکیب کنید تا پاسخ هوش مصنوعی را هدایت کنید.

برای مثال، اگر در حال ساخت برنامه‌ای برای پاسخ به سؤالات درباره ماشین‌ها هستید، می‌توانید درخواستی مانند زیر داشته باشید:

```text

## دستورالعمل‌ها
به سؤالات درباره ماشین‌ها فقط با استفاده از منابع زیر پاسخ دهید.
اگر داده کافی در منابع ارائه‌شده وجود ندارد، بگویید که نمی‌دانید.
مختصر و مستقیم به نقطه بپردازید.

## منابع
<اطلاعات بازیافتی را اینجا وارد کنید>

## سؤال
<سؤال را اینجا وارد کنید>
```

با ارائه زمینه و اطلاعات اضافی به مدل هوش مصنوعی، می‌توانید به فرآیند تولید کمک کنید و مطمئن شوید که پاسخ‌ها دقیق و مرتبط با موضوع هستند.

> [!TIP]
> به این بخش از درخواست توجه کنید: `اگر داده کافی در منابع ارائه‌شده وجود ندارد، بگویید که نمی‌دانید.`. این مهم است تا از تولید اطلاعات نادرست توسط هوش مصنوعی وقتی داده کافی برای ارائه پاسخ قابل اعتماد وجود ندارد جلوگیری شود. این تکنیک *راه فرار* نامیده می‌شود و یک روش خوب برای اطمینان از کیفیت محتوای تولیدشده است.

RAG را می‌توان به عنوان یک شکل پیشرفته از *مهندسی درخواست* در نظر گرفت.

### مثال کد

**آدا:** تمرین باعث مهارت می‌شود، پس بیایید آنچه را که آموخته‌ایم با یک مثال به کار ببریم. یک سیستم بازیابی ساده در یک برنامه جاوااسکریپت با استفاده از یک فایل [CSV](https://fr.wikipedia.org/wiki/Comma-separated_values) از داده‌های ماشین‌های هیبریدی و یک الگوریتم جستجوی پایه برای استخراج اطلاعات مرتبط بر اساس سؤال کاربر می‌سازیم.

```javascript
// This example demonstrates how to use the Retrieval Augmented Generation (RAG)
// to answer questions based on a hybrid car data set.
// The code below reads the CSV file, searches for matches to the user question,
// and then generates a response based on the information found.

import { fileURLToPath } from 'node:url';
import { dirname } from 'node:path';
import process from "node:process";
import fs from "node:fs";
import { OpenAI } from "openai";

// Change the current working directory to the directory of the script
const __dirname = dirname(fileURLToPath(import.meta.url));
process.chdir(__dirname);

// 1. Ask a question about hybrid cars
// -----------------------------------

const question = `what's the fastest prius`;

// 2. Retriever component: search the data for relevant information
// ----------------------------------------------------------------

// Load CSV data as an array of objects
const rows = fs.readFileSync("./hybrid.csv", "utf8").split("\n");
const columns = rows[0].split(",");

// Search the data using a very naive search
const words = question
  .toLowerCase()
  .replaceAll(/[.?!()'":,]/g, "")
  .split(" ")
  .filter((word) => word.length > 2);
const matches = rows.slice(1).filter((row) => words.some((word) => row.toLowerCase().includes(word)));

// Format as a markdown table, since language models understand markdown
const table =
  `| ${columns.join(" | ")} |\n` +
  `|${columns.map(() => "---").join(" | ")}|\n` +
  matches.map((row) => `| ${row.replaceAll(",", " | ")} |\n`).join("");

console.log(`Found ${matches.length} matches:`);
console.log(table);

// 3. Context augmentation: create a combined prompt with the search results
// --------------------------------------------------------------------------

const augmentedPrompt = `
## Instructions
Answer questions about a time period or characters from said time period using only the sources below.
If there's not enough data in provided sources, say that you don't know.
Be brief and straight to the point.

## Sources
${table}

## Question
${question}
`;

// 4. Generator component: use the search results to generate a response
// ---------------------------------------------------------------------

const openai = new OpenAI({
  baseURL: "https://models.inference.ai.azure.com",
  apiKey: process.env.GITHUB_TOKEN,
});

const chunks = await openai.chat.completions.create({
  model: "gpt-4o-mini",
  messages: [{ role: "user", content: augmentedPrompt }],
  stream: true,
});

console.log(`Answer for "${question}":`);

for await (const chunk of chunks) {
  process.stdout.write(chunk.choices[0].delta.content ?? "");
}
```

می‌توانید این کد را در فایل [`example/rag-cars.js`](./example/rag-cars.js) همراه با فایل [`hybrid.csv`](./example/hybrid.csv) حاوی داده‌های استفاده‌شده برای بازیابی پیدا کنید.

**آدا:** پس از اجرای این کد، باید داده‌های یافت‌شده در فایل CSV توسط بازیاب را ببینید، که به صورت یک جدول markdown قالب‌بندی شده است، و پس از آن پاسخ تولیدشده توسط هوش مصنوعی به سؤال. سؤال را تغییر دهید تا ببینید چگونه داده‌های بازیافتی و پاسخ تغییر می‌کنند. همچنین می‌توانید سؤالاتی درباره موضوعات نامرتبط بپرسید تا ببینید مدل هوش مصنوعی چگونه با آن‌ها برخورد می‌کند.

```text
Example of the output:

Found 1 matches:
| Person | Time Period | Description |
|---|---|---|
| Leonardo Da Vinci | 15th century | Italian polymath known for his art and inventions. |
| Isaac Newton | 17th century | English mathematician and physicist who formulated the laws of motion and universal gravitation. |
```

**شما:** این عالی است، می‌توانم ببینم که چگونه این می‌تواند هنگام استفاده از دستگاه مفید باشد، یا بهتر بگویم چگونه قبلاً بوده یا خواهد بود، سفر در زمان گیج‌کننده است *آه*.

**آدا:** آره آره، داری عالی پیش می‌ری. بیا به مرحله بعدی برویم.

## تکلیف - کمک به آدا و چارلز

حالا که درباره RAG آموخته‌اید، آماده هستید تا به آدا و چارلز با دستگاهشان کمک کنید. با این حال، با بررسی دقیق‌تر، دستگاه آشنا به نظر می‌رسد.

**شما:** سوسک زمان، می‌دانی این چیست؟

**سوسک زمان:** البته، این من هستم، یا خواهد بود. البته چند قطعه کم دارد. حالا که فکر می‌کنم، قطعات زیادی کم دارد، حتی هنوز پوسته ندارد.

**آدا:** سوسک زمان دستگاهی است که به شما امکان سفر در زمان و مکان را می‌دهد، البته وقتی که درست کار کند. همانطور که گفتم، باید یک ویژگی جدید به آن اضافه کنیم، یک ماژول تولید تقویت‌شده با بازیابی (RAG). این به ما کمک می‌کند اطلاعات و زمینه مورد نیاز را از دوره‌های زمانی مختلف در حین سفر بازیابی کنیم. می‌خواهیم مطمئن شویم به انواع منابع مراجعه می‌کنیم، ویکی‌پدیا شروع خوبی است.

**شما:** چه کاری باید انجام دهم؟

**آدا:** اینجا کد مثالی است که اطلاعات متنی درباره تیم برنرز-لی را از ویکی‌پدیا بازیابی می‌کند، تیم در آینده بسیار مهم خواهد بود.

```javascript
const response = await fetch('https://en.wikipedia.org/w/api.php?format=json&action=query&prop=extracts&redirects=true&explaintext&titles=Tim%20Berners-Lee');
const data = await response.json();
const text = Object.values(data.query.pages)[0]?.extract;
```

**شما:** من تنها کسی نیستم که به آینده سفر کرده‌ام؟

**آدا:** ...

## راه‌حل

[راه‌حل](./solution/rag-www.js)

## آزمون دانش

**سؤال**: نقش بازیاب در یک سیستم RAG چیست؟

A. بازیاب پاسخ‌ها را بر اساس داده‌های ورودی تولید می‌کند.

B. بازیاب اطلاعات مرتبط را بر اساس داده‌های آموزشی مدل تولید می‌کند.

C. بازیاب اطلاعات مرتبط را از منابع داده خارجی پیدا می‌کند.

[پاسخ آزمون](./solution/solution-quiz.md)

## منابع خودآموزی

- [تولید تقویت‌شده با بازیابی و نمایه‌ها](https://learn.microsoft.com/azure/ai-studio/concepts/retrieval-augmented-generation)
- **برنامه‌های نمونه**:
  * [چت هوش مصنوعی بدون سرور با RAG](https://github.com/Azure-Samples/serverless-chat-langchainjs/)
  * [Ask Youtube: یک API پرسش و پاسخ مبتنی بر RAG برای یوتیوب](https://github.com/Azure-Samples/langchainjs-quickstart-demo)
- [کارگاه کامل: ChatGPT خود را با RAG بسازید](https://moaw.dev/workshop/gh:azure-samples/azure-openai-rag-workshop/docs/workshop-qdrant.md)
